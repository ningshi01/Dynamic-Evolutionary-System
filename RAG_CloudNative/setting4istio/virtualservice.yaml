apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: application-vs
  namespace: default
spec:
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway
  http:
  # API 服务路由
  - match:
    - uri:
        prefix: /api
    - uri:
        prefix: /v1
    route:
    - destination:
        host: api-service.default.svc.cluster.local
        port:
          number: 80
  
  # 文件服务路由
  - match:
    - uri:
        prefix: /files
    - uri:
        prefix: /upload
    - uri:
        prefix: /download
    route:
    - destination:
        host: fileservice-service.default.svc.cluster.local
        port:
          number: 80
  
  # 嵌入服务路由
  - match:
    - uri:
        prefix: /embedding
    - uri:
        prefix: /vector
    route:
    - destination:
        host: embedding-service.default.svc.cluster.local
        port:
          number: 80
  
  # LLM 服务路由
  - match:
    - uri:
        prefix: /llm
    - uri:
        prefix: /chat
    - uri:
        prefix: /generate
    route:
    - destination:
        host: llm-service.default.svc.cluster.local
        port:
          number: 80
  
  # 解析器服务路由
  - match:
    - uri:
        prefix: /parse
    - uri:
        prefix: /parser
    route:
    - destination:
        host: parser-service.default.svc.cluster.local
        port:
          number: 80
  
  # 重排服务路由
  - match:
    - uri:
        prefix: /rerank
    - uri:
        prefix: /reranker
    route:
    - destination:
        host: reranker-service.default.svc.cluster.local
        port:
          number: 80
  
  # 检索服务路由
  - match:
    - uri:
        prefix: /search
    - uri:
        prefix: /retrieve
    route:
    - destination:
        host: retriever-service.default.svc.cluster.local
        port:
          number: 80
  
  # Milvus 向量数据库路由（如果需要通过网关访问）
  - match:
    - uri:
        prefix: /milvus
    - uri:
        prefix: /vectors
    route:
    - destination:
        host: milvus-service.default.svc.cluster.local
        port:
          number: 19530
  
  # 默认路由（可指向 API 服务或返回 404）
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: api-service.default.svc.cluster.local
        port:
          number: 80